#ifndef INC_BASESYSTEMMODBUS_H_
#define INC_BASESYSTEMMODBUS_H_

// PRIVATE INCLUDE ================================================================================

// PRIVATE TYPEDEF ================================================================================

typedef struct {
	// read only variables ============================================================================
	int16_t base_system_status;		// [0 set pick, 1 set place, 2 home, 3 tray mode, 4 point mode]
	int16_t goal_point_x;			// telling our system where to go
	int16_t goal_point_y;
	int16_t x_actual_position;
	int16_t x_actual_speed;

	// write only variable ============================================================================
	int16_t y_moving_status;		// [0 jog pick, 1 jog place, 2 home, 3 go pick, 4 go place, 5 go point]
	int16_t y_actual_position;
	int16_t y_actual_speed;
	int16_t y_actual_acceleration;
	int16_t pick_tray_origin_x;
	int16_t pick_tray_origin_y;
	int16_t pick_tray_orientation;
	int16_t place_tray_origin_x;
	int16_t place_tray_origin_y;
	int16_t place_tray_orientation;
	int16_t x_target_position;
	int16_t x_target_speed;
	int16_t x_target_acceleration_time;	// [1 100ms, 2 500ms, 3 1000ms]

	// read/write variables  ==========================================================================
	int16_t heartbeat;					// [0 base system disconnected, 1 base system is connected]
	int16_t end_effector_status;		// [0 laser on/off, 1 power, 2 picking, 3 placing]
	int16_t x_moving_status;			// [0 home, 1 run, 2 jog left -, 3 jog right +]
} MB;

// PRIVATE FUNCTION PROTOTYPE =====================================================================

void modbus_heartbeat_handler(u16u8_t *registerFrame, MB *variables);

// USER CODE ======================================================================================

void modbus_heartbeat_handler(u16u8_t *registerFrame, MB *variables) {
	static int8_t fail = 0;
	static uint32_t timestamp = 0;
	if (HAL_GetTick() >= timestamp) {
		timestamp = HAL_GetTick() + 200;

		// check if the base system send heartbeat
		if (registerFrame[0].U16 == 18537) {
			// success
			variables->heartbeat = 1;
			fail = 0;
		} else {
			// fail, count failure
			if (fail < 126) {
				fail++;
			}
			// if fail is too high then system is disconnected
			if (fail > 9) {
				variables->heartbeat = 0;
			}
		}

		// set heartbeat for base system to see
		registerFrame[0].U16 = 22881;
	}
}

// USER CODE END ==================================================================================

#endif /* INC_BASESYSTEMMODBUS_H_ */
